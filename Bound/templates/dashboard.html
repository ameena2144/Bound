{% extends "base.html" %}

{% block title %}Dashboard - Legal Case Binder{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Hero Section -->
    <div class="glass-card mb-4 p-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1 text-gradient-purple">{{ case.case_title }}</h1>
                <p class="text-muted mb-0">
                    <i data-feather="briefcase" class="me-2" style="width: 1rem; height: 1rem;"></i>
                    {{ case.case_type }} 
                    {% if case.court_name %}
                        | <i data-feather="map-pin" class="me-1" style="width: 1rem; height: 1rem;"></i>{{ case.court_name }}
                    {% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('case_summary') }}" class="btn btn-outline-primary">
                    <i data-feather="file-text" class="me-1"></i>AI Summary
                </a>
                <a href="{{ url_for('preparation_checklist') }}" class="btn btn-primary">
                    <i data-feather="check-square" class="me-1"></i>Prepare Case
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards Row -->
    <div class="row mb-5">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ stats.total_children }}</div>
                <div class="stat-label">Children</div>
                <div class="mt-2">
                    <i data-feather="users" style="color: var(--primary-purple); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ stats.total_parents }}</div>
                <div class="stat-label">Parents</div>
                <div class="mt-2">
                    <i data-feather="user" style="color: var(--secondary-purple); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ stats.total_documents }}</div>
                <div class="stat-label">Documents</div>
                <div class="mt-2">
                    <i data-feather="folder" style="color: var(--success); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ stats.open_deadlines }}</div>
                <div class="stat-label">Deadlines</div>
                <div class="mt-2">
                    <i data-feather="clock" style="color: var(--warning); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ stats.total_incidents }}</div>
                <div class="stat-label">Incidents</div>
                <div class="mt-2">
                    <i data-feather="alert-triangle" style="color: var(--danger); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stat-card gpu-accelerated">
                <div class="stat-number">{{ (recent_documents|length + recent_incidents|length + upcoming_deadlines|length) }}</div>
                <div class="stat-label">Recent Activity</div>
                <div class="mt-2">
                    <i data-feather="activity" style="color: var(--info); width: 1.5rem; height: 1.5rem;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Chronological Timeline -->
        <div class="col-lg-8 mb-4">
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-gradient-purple mb-0">
                        <i data-feather="clock" class="me-2"></i>Case Timeline
                    </h3>
                    <a href="{{ url_for('timeline') }}" class="btn btn-outline-primary btn-sm">
                        <i data-feather="maximize-2" class="me-1"></i>Full Timeline
                    </a>
                </div>
                
                <div class="timeline-container">
                    {% set all_events = [] %}
                    
                    <!-- Collect all events -->
                    {% for doc in recent_documents[:10] %}
                        {% set _ = all_events.append({
                            'date': doc.created_at,
                            'type': 'document',
                            'title': 'Document Added: ' + doc.original_filename,
                            'description': doc.ai_summary[:100] + '...' if doc.ai_summary and doc.ai_summary|length > 100 else doc.description or 'Document uploaded',
                            'icon': 'file-text',
                            'color': 'var(--success)',
                            'id': doc.id
                        }) %}
                    {% endfor %}
                    
                    {% for incident in recent_incidents %}
                        {% set _ = all_events.append({
                            'date': incident.created_at,
                            'type': 'incident',
                            'title': 'Incident: ' + incident.title,
                            'description': incident.description[:100] + '...' if incident.description|length > 100 else incident.description,
                            'icon': 'alert-triangle',
                            'color': 'var(--danger)' if incident.severity == 'critical' else 'var(--warning)' if incident.severity == 'high' else 'var(--info)',
                            'severity': incident.severity
                        }) %}
                    {% endfor %}
                    
                    {% for deadline in upcoming_deadlines[:5] %}
                        {% set _ = all_events.append({
                            'date': deadline.created_at,
                            'type': 'deadline',
                            'title': 'Deadline Set: ' + deadline.title,
                            'description': 'Due: ' + deadline.deadline_date.strftime('%m/%d/%Y at %I:%M %p'),
                            'icon': 'calendar',
                            'color': 'var(--primary-purple)',
                            'priority': deadline.priority
                        }) %}
                    {% endfor %}

                    <!-- Sort by date descending -->
                    {% set sorted_events = all_events|sort(attribute='date', reverse=true) %}
                    
                    {% if sorted_events %}
                        {% for event in sorted_events[:15] %}
                            <div class="timeline-item">
                                <div class="timeline-date">
                                    {{ event.date.strftime('%m/%d') }}<br>
                                    <small>{{ event.date.strftime('%I:%M %p') }}</small>
                                </div>
                                <div class="timeline-content">
                                    <div class="d-flex align-items-start">
                                        <div class="me-3" style="color: {{ event.color }};">
                                            <i data-feather="{{ event.icon }}" style="width: 1.25rem; height: 1.25rem;"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">{{ event.title }}</h6>
                                            <p class="mb-1 text-muted small">{{ event.description }}</p>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge badge-sm" style="background: {{ event.color }}; color: white;">
                                                    {{ event.type|title }}
                                                </span>
                                                {% if event.severity %}
                                                    <span class="badge badge-sm bg-secondary">{{ event.severity|title }}</span>
                                                {% endif %}
                                                {% if event.priority %}
                                                    <span class="badge badge-sm bg-info">{{ event.priority|title }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i data-feather="clock" style="width: 3rem; height: 3rem;" class="mb-3 opacity-50"></i>
                            <h5>No Recent Activity</h5>
                            <p>Start by adding documents, logging incidents, or setting deadlines.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Quick Actions & Insights -->
        <div class="col-lg-4">
            <!-- Quick Actions Carousel -->
            <div class="glass-card mb-4">
                <div class="card-header bg-transparent border-0 p-4">
                    <h5 class="text-gradient-purple mb-0">
                        <i data-feather="zap" class="me-2"></i>Quick Actions
                    </h5>
                </div>
                <div id="quickActionsCarousel" class="carousel slide modern-carousel" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#quickActionsCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#quickActionsCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#quickActionsCarousel" data-bs-slide-to="2"></button>
                    </div>
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class="p-4">
                                <h6 class="text-primary mb-3">
                                    <i data-feather="users" class="me-2"></i>Manage Profiles
                                </h6>
                                <div class="d-grid gap-3">
                                    <a href="{{ url_for('add_child') }}" class="btn btn-outline-primary">
                                        <i data-feather="user-plus" class="me-2"></i>Add Child Profile
                                    </a>
                                    <a href="{{ url_for('add_parent') }}" class="btn btn-outline-primary">
                                        <i data-feather="user-plus" class="me-2"></i>Add Parent Profile
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="p-4">
                                <h6 class="text-success mb-3">
                                    <i data-feather="folder-plus" class="me-2"></i>Document Management
                                </h6>
                                <div class="d-grid gap-3">
                                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                        <i data-feather="upload" class="me-2"></i>Upload Document
                                    </button>
                                    <a href="{{ url_for('documents') }}" class="btn btn-outline-success">
                                        <i data-feather="folder" class="me-2"></i>View All Documents
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="p-4">
                                <h6 class="text-warning mb-3">
                                    <i data-feather="alert-circle" class="me-2"></i>Case Tracking
                                </h6>
                                <div class="d-grid gap-3">
                                    <a href="{{ url_for('add_incident') }}" class="btn btn-outline-warning">
                                        <i data-feather="plus-circle" class="me-2"></i>Log Incident
                                    </a>
                                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#deadlineModal">
                                        <i data-feather="calendar-plus" class="me-2"></i>Add Deadline
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#quickActionsCarousel" data-bs-slide="prev">
                        <i data-feather="chevron-left"></i>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#quickActionsCarousel" data-bs-slide="next">
                        <i data-feather="chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Insights Accordion -->
            <div class="glass-card">
                <div class="card-header bg-transparent border-0 p-4">
                    <h5 class="text-gradient-purple mb-0">
                        <i data-feather="bar-chart-2" class="me-2"></i>Case Insights
                    </h5>
                </div>
                <div class="accordion" id="insightsAccordion">
                    <!-- Upcoming Deadlines -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#deadlinesCollapse">
                                <i data-feather="clock" class="me-2"></i>
                                Urgent Deadlines ({{ stats.open_deadlines }})
                            </button>
                        </h2>
                        <div id="deadlinesCollapse" class="accordion-collapse collapse show" data-bs-parent="#insightsAccordion">
                            <div class="accordion-body">
                                {% if upcoming_deadlines %}
                                    {% for deadline in upcoming_deadlines[:3] %}
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="me-3">
                                                <div class="badge" style="background: {% if deadline.priority == 'critical' %}var(--danger){% elif deadline.priority == 'high' %}var(--warning){% else %}var(--primary-purple){% endif %};">
                                                    {{ deadline.priority[0]|upper }}
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold small">{{ deadline.title }}</div>
                                                <div class="text-muted small">
                                                    <i data-feather="calendar" class="me-1" style="width: 0.75rem; height: 0.75rem;"></i>
                                                    {{ deadline.deadline_date.strftime('%m/%d/%Y') }}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <a href="{{ url_for('deadlines') }}" class="btn btn-outline-primary btn-sm w-100">View All</a>
                                {% else %}
                                    <div class="text-muted small text-center py-3">
                                        <i data-feather="check-circle" class="me-2"></i>No urgent deadlines
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Recent Documents -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#documentsCollapse">
                                <i data-feather="file-text" class="me-2"></i>
                                Recent Documents ({{ recent_documents|length }})
                            </button>
                        </h2>
                        <div id="documentsCollapse" class="accordion-collapse collapse" data-bs-parent="#insightsAccordion">
                            <div class="accordion-body">
                                {% if recent_documents %}
                                    {% for doc in recent_documents[:3] %}
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="me-3">
                                                <i data-feather="{% if doc.file_type == 'pdf' %}file-text{% elif doc.file_type in ['doc', 'docx'] %}file-text{% elif doc.file_type in ['jpg', 'png', 'jpeg'] %}image{% else %}file{% endif %}" 
                                                   class="text-success" style="width: 1rem; height: 1rem;"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold small">{{ doc.original_filename[:25] }}...</div>
                                                <div class="text-muted small">{{ doc.created_at.strftime('%m/%d/%Y') }}</div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <a href="{{ url_for('documents') }}" class="btn btn-outline-success btn-sm w-100">View All</a>
                                {% else %}
                                    <div class="text-muted small text-center py-3">
                                        <i data-feather="folder" class="me-2"></i>No documents yet
                                        <button type="button" class="btn btn-outline-primary btn-sm mt-2 w-100" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                            Upload First Document
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Case Information -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#caseInfoCollapse">
                                <i data-feather="info" class="me-2"></i>
                                Case Information
                            </button>
                        </h2>
                        <div id="caseInfoCollapse" class="accordion-collapse collapse" data-bs-parent="#insightsAccordion">
                            <div class="accordion-body">
                                <div class="small">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Case Type:</span>
                                        <span>{{ case.case_type }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Court:</span>
                                        <span>{{ case.court_name or 'Not specified' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Case Number:</span>
                                        <span>{{ case.case_number or 'Not specified' }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Filing Date:</span>
                                        <span>{{ case.filing_date.strftime('%m/%d/%Y') if case.filing_date else 'Not specified' }}</span>
                                    </div>
                                    <hr class="my-3">
                                    <a href="{{ url_for('case_summary') }}" class="btn btn-primary btn-sm w-100">
                                        <i data-feather="brain" class="me-2"></i>Generate AI Summary
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('upload_document') }}" enctype="multipart/form-data">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-gradient-purple">
                        <i data-feather="upload" class="me-2"></i>Upload Document
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="file" class="form-label">Choose File</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                        <div class="form-text">Supported: PDF, DOC, DOCX, TXT, images, audio</div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Brief description..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="document_date" class="form-label">Document Date</label>
                        <input type="date" class="form-control" id="document_date" name="document_date">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_court_filing" name="is_court_filing">
                        <label class="form-check-label" for="is_court_filing">This is a court filing</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_confidential" name="is_confidential">
                        <label class="form-check-label" for="is_confidential">Mark as confidential</label>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="upload" class="me-2"></i>Upload & Analyze
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Deadline Modal -->
<div class="modal fade" id="deadlineModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_deadline') }}">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-gradient-purple">
                        <i data-feather="calendar-plus" class="me-2"></i>Add Deadline
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="deadline_date" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="deadline_date" name="deadline_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="deadline_type" class="form-label">Type</label>
                        <select class="form-select" id="deadline_type" name="deadline_type" required>
                            <option value="court_hearing">Court Hearing</option>
                            <option value="filing_deadline">Filing Deadline</option>
                            <option value="mediation">Mediation</option>
                            <option value="evaluation">Evaluation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority" name="priority">
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="calendar-plus" class="me-2"></i>Add Deadline
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}